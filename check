package com.citi.eq.tds.re.rule.core;


import com.citi.eq.tds.re.rule.event.Event;
import com.citi.eq.tds.re.rule.loader.RulesLoader;
import com.citi.eq.tds.re.rule.loader.RulesLoaderFactory;
import com.citi.eq.tds.re.rule.util.AssertArgument;
import org.apache.commons.io.FilenameUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import static java.lang.String.format;

/**
 * Created by mv29256 on 10/15/2015.
 */
public class RuleSet {

    private static final Logger LOGGER = LoggerFactory.getLogger(RuleSet.class);
    private static final RuleSet EMPTY_RULESET = new RuleSet("Empty ruleset");
    private final Set<Rule<Event>> rules;
    private final String name;

    private RuleSet(String name) {
        this(name, 10);
    }

    public RuleSet(String name, int size) {
        this.name = name;
        rules = new HashSet<>(size);
    }

    public static RuleSet loadFrom(File rulesDir, String pattern) {
        AssertArgument.isNotNull(rulesDir, pattern);
        RulesLoader rulesLoader = RulesLoaderFactory.getLoaderFor(rulesDir, pattern);

        File[] rulesFiles = rulesDir.listFiles((dir, name) -> {
            return name.matches(pattern);
        });

        RuleSet set = EMPTY_RULESET;

        if (rulesFiles != null) {
            for (File rulesFile : rulesFiles) {
                if (set == EMPTY_RULESET) {
                    String ruleset = FilenameUtils.removeExtension(rulesFile.getName());
                    set = new RuleSet(ruleset);

                    if (LOGGER.isInfoEnabled()) {
                        LOGGER.info(format("[%s] from [%s]", ruleset, rulesFile));
                    }
                }
                List<RuleBuilder> rules = rulesLoader.getRulesFor(rulesFile);
                set.addAll(rules);
            }
        }

        return set;
    }

    public Set<Rule<Event>> getRules() {
        return this.rules;
    }

    public String getName() {
        return name;
    }

    public void add(Rule<Event> r) {
        this.rules.add(r);
    }

    @Override
    public String toString() {
        StringBuilder b = new StringBuilder(format("Ruleset [%d rules]: ", rules.size()));
        b.append(rules);
        return b.toString();
    }

    private void addAll(List<RuleBuilder> rules) {
        rules.addAll(rules);
    }
}
